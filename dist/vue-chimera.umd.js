!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("axios")):"function"==typeof define&&define.amd?define(["exports","axios"],t):t((e=e||self)["vue-chimera"]={},e.Axios)}(this,(function(e,t){"use strict";var n="default"in t?t.default:t;function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(){return(c=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function u(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function h(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?u(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):u(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function d(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}function y(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function v(e,t,n){return(v="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=f(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(n):i.value}})(e,t,n||e)}function m(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if(!(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)))return;var n=[],r=!0,i=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(r=(s=a.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{r||null==a.return||a.return()}finally{if(i)throw o}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function b(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var g=(e,t,n)=>{if(!Number.isFinite(t))throw new TypeError("Expected `wait` to be a finite number");let r,i;n=n||{};let o=[];return function(){const s=this,a=arguments;return new Promise(c=>{const u=n.leading&&!i;clearTimeout(i),i=setTimeout(()=>{i=null;const t=n.leading?r:e.apply(s,a);for(c of o)c(t);o=[]},t),u?(r=e.apply(s,a),c(r)):o.push(c)})}},O=Object.freeze({__proto__:null,SUCCESS:"success",ERROR:"error",CANCEL:"cancel",LOADING:"loading",TIMEOUT:"timeout"});function _(e){return"object"===r(e)&&e&&"[object Object]"===Object.prototype.toString(e)}function j(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=Object.assign.apply(Object,[{}].concat(t));return Object.keys(t[0]).reduce((function(e,t){return e[t]=r[t],e}),{})}var w=function(e,t){return t in(e||{})};function k(e){try{var t=window;return e.split(".").forEach((function(e){t=t[e]})),t}catch(e){}return null}function C(e){return e}function E(e){for(var t,n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];(t=console).warn.apply(t,["[Chimera]: "+e].concat(r))}var S={request:function(e,r){var i,o=r.axios?"function"==typeof(i=r.axios)?"function"==typeof i.request?i:i():_(i)?n.create(i):n:n;return"get"!==(e.method||"get")&&e.params&&(e.data=e.params,delete e.params),o.request(h({},e,{cancelToken:new t.CancelToken((function(e){r._canceler=e}))}))},cancel:function(e){"function"==typeof e._canceler&&e._canceler(),e._canceler=null},isCancelError:function(e){return n.isCancel(e)}},x={status:null,data:null,headers:null,error:null,lastLoaded:null},P={url:null,baseURL:null,method:"get",params:null,timeout:0,headers:null},$=function(){function e(t,n){if(i(this,e),"string"==typeof t&&(t={url:t,key:t}),!t)throw E("Invalid options",t),new Error("[Chimera]: invalid options");var r=t,o=r.debounce,s=r.transformer,a=r.interval,c=r.on,u=d(r,["debounce","transformer","interval","on"]);if(u.method=(u.method||"get").toLowerCase(),this.fetchDebounced=!1!==o?g(this.fetch.bind(this),o||50,{leading:!0}):this.fetch,this.setTransformer(s),this.prefetched=!1,this.loading=!1,this.listeners={},_(c))for(var h in c)this.on(h,c[h]);Object.assign(this,u),"string"==typeof this.auto?this.auto=this.auto.toLowerCase()===this.method:this.auto=Boolean(this.auto),this.prefetch=null!=this.prefetch?this.prefetch:this.auto,Object.assign(this,x,n||{}),this.http=S,a&&this.startInterval(a)}return s(e,[{key:"setTransformer",value:function(e){if("function"==typeof e)this.responseTransformer=e,this.errorTransformer=e;else if(_(e)){var t=e.response,n=e.error;this.responseTransformer=t||C,this.errorTransformer=n||C}else this.responseTransformer=C,this.errorTransformer=C}},{key:"on",value:function(e,t){var n=this.listeners[e]||[];return n.push(t),this.listeners[e]=n,this}},{key:"emit",value:function(e){var t=this;(this.listeners[e]||[]).forEach((function(n){n(t,e)}))}},{key:"fetch",value:function(e,t){var n=this;return new Promise((function(r,i){if(n.cache&&!e){var o=n.getCache();if(o)return n.setResponse(o),r(o)}var s=n.request;_(t)&&(t.params&&(t.params=Object.assign({},s.params,t.params)),s=Object.assign({},s,t)),n.loading=!0,n.emit("loading"),n.http.request(s,n).then((function(e){n.loading=!1,n.setResponse(e),n.setCache(e),n.emit("success"),r(e)})).catch((function(e){n.loading=!1,n.setResponse(e.response),n.http.isCancelError(e)?n.emit("cancel"):(e.message&&!e.response&&-1!==e.message.indexOf("timeout")&&n.emit("timeout"),n.emit("error")),i(e)}))}))}},{key:"reload",value:function(e){return this.fetchDebounced(e)}},{key:"send",value:function(e){return this.fetchDebounced(!0,{params:e})}},{key:"cancel",value:function(){this.http.cancel(this)}},{key:"getCacheKey",value:function(){return this.key?this.key:("undefined"!=typeof window&&"undefined"!=typeof btoa?window.btoa:function(e){return e})(Object.values(this.request).join(":"))}},{key:"getCache",value:function(){return this.cache?this.cache.getItem(this.getCacheKey()):void 0}},{key:"setCache",value:function(e){this.cache&&this.cache.setItem(this.getCacheKey(),e)}},{key:"deleteCache",value:function(){this.cache&&this.cache.removeItem(this.getCacheKey())}},{key:"setResponse",value:function(e){e=e||{};var t="2"===String(e.status).charAt(0);this.status=e.status,this.headers=e.headers||{},this.lastLoaded=new Date,this.data=t?this.responseTransformer(e.data,this):null,this.error=t?null:this.errorTransformer(e.data,this)}},{key:"startInterval",value:function(e){var t=this;if("number"!=typeof e)throw new Error("[Chimera]: interval should be number");"undefined"!=typeof process&&process.server||(this._interval=e,this.stopInterval(),this._interval_id=setInterval((function(){return t.reload(!0)}),this._interval))}},{key:"stopInterval",value:function(){this._interval_id&&(clearInterval(this._interval_id),this._interval_id=null,this._interval=!1)}},{key:"toString",value:function(){return JSON.stringify(this.response)}},{key:"looping",get:function(){return!!this._interval}},{key:"request",get:function(){return j(P,this,{baseURL:this.baseURL,timeout:this.timeout,headers:this.headers})}},{key:"response",get:function(){return j(x,this)}}]),e}(),I=function(e){function t(){return i(this,t),y(this,f(t).call(this,{}))}return l(t,e),s(t,[{key:"fetch",value:function(e){return Promise.reject(new Error("[Chimera]: Fetching null endpoint"))}},{key:"cancel",value:function(){}}]),t}($),T=function(e){return e.auto&&(!e.prefetched||"override"===e.prefetch)},A=function(){function e(t,n,r){var o=this,s=c({},n);if(i(this,e),this._vm=t,this._watchers=[],r){var a=r.deep,u=r.ssrContext,h=d(r,["deep","ssrContext"]);this.LocalEndpoint=function(e){function t(){return i(this,t),y(this,f(t).apply(this,arguments))}return l(t,e),t}($),Object.assign(this.LocalEndpoint.prototype,h),Object.assign(this,JSON.parse(JSON.stringify({deep:a,ssrContext:u})))}this._ssrContext=k(this.ssrContext),this._server=t.$isServer;var p={immediate:!0,deep:this._deep,sync:!0},v=function(e){if("$"===e.charAt(0))return delete s[e],"continue";var t=s[e];"function"==typeof t?o._watchers.push([function(){return t.call(o._vm)},function(t,n){return o.updateEndpoint(e,t,n)},p]):(t=s[e]=o.endpointFrom(t),o._server||T(t)&&t.reload())};for(var m in s)v(m);Object.defineProperty(s,"$cancelAll",{value:function(){return o.cancelAll()}}),Object.defineProperty(s,"$loading",{get:function(){return!!Object.values(this).find((function(e){return!!e.loading}))}}),this.endpoints=s;var b=this._vm.$options,g=b.computed=b.computed||{};Object.keys(s).forEach((function(e){w(g,e)||w(b.props,e)||w(b.methods,e)||(g[e]=function(){return o.endpoints[e]})}))}return s(e,[{key:"init",value:function(){var e=this;this._watchers=this._watchers.map((function(t){var n;return(n=e._vm).$watch.apply(n,b(t))}))}},{key:"initServer",value:function(){var e=this;this._vm.$_chimeraPromises=[],Object.values(this.endpoints).forEach((function(t){if(t.prefetch){if(!t.key)return void E("used prefetch with no key associated with endpoint!");e._vm.$_chimeraPromises.push(t.fetch(!0,{timeout:t.prefetchTimeout}).then((function(){return t})).catch((function(){return null})))}}))}},{key:"updateEndpoint",value:function(e,t,n){var r=this.endpoints[e],i=this.endpointFrom(t,n&&n.keepData?r.toObj():null);n&&r&&(r.stopInterval(),i.lastLoaded=r.lastLoaded),this._server||T(i)&&i.reload(),this._vm.$set(this.endpoints,e,i)}},{key:"endpointFrom",value:function(e,t){var n=this;if(null==e)return new I;"string"==typeof e&&(e={url:e}),_(e.on)&&Object.entries(e.on).forEach((function(t){var r=m(t,2),i=r[0],o=r[1];"function"==typeof o&&(o=o.bind(n._vm)),"string"==typeof o&&(o=n._vm[o]),e.on[i]=o}));var r=new(this.LocalEndpoint||$)(e,t);return!this._server&&!t&&r.key&&r.prefetch&&this._ssrContext&&((t=this._ssrContext[e.key])&&(t.prefetched=!0),Object.assign(r,t)),r}},{key:"cancelAll",value:function(){Object.values(this.endpoints).forEach((function(e){e.cancel()}))}},{key:"destroy",value:function(){var e=this._vm;this.cancelAll(),Object.values(this.endpoints).forEach((function(e){e.stopInterval()})),delete e._chimera}}]),e}(),R={beforeCreate:function(){console.log("sssssJ");var e,t=this.$options;if(t.chimera&&!t._chimera){if("function"==typeof t.chimera&&(t.chimera=t.chimera.call(this)),!_(t.chimera))throw new Error("[Chimera]: chimera options should be an object or a function that returns object");var n=t.chimera,r=n.$options,i=d(n,["$options"]);e=new A(this,i,r),this._chimera=e,Object.prototype.hasOwnProperty.call(this,"$chimera")||Object.defineProperty(this,"$chimera",{get:function(){return e.endpoints}})}},data:function(){return this._chimera?{$chimera:this._chimera.endpoints}:{}},created:function(){this._chimera&&(this._chimera.init(),this.$isServer&&this._chimera.initServer())},beforeDestroy:function(){this._chimera&&this._chimera.destroy()},serverPrefetch:function(){if(this.$_chimeraPromises){var e=require("../ssr/index");return Promise.all(this.$_chimeraPromises).then((function(t){t.forEach((function(t){t&&e.addEndpoint(t)}))}))}}},L={inheritAttrs:!1,props:{options:{type:[Object,String],required:!0},tag:{type:String,default:null}},data:function(){return{endpoint:this.getEndpoint()}},beforeCreate:function(){this._ssrContext=k(this.$chimeraOptions.ssrContext)},render:function(e){var t=this.$scopedSlots.default(this.endpoint);return t=Array.isArray(t)?t.concat(this.$slots.default):[t].concat(this.$slots.default),this.tag?e(this.tag,t):t[0]},created:function(){var e=this.endpoint;this.$isServer&&e.key&&(this.$_chimeraPromises=[e.fetch(!0).then((function(){return e})).catch((function(){return null}))])},mounted:function(){var e=this.endpoint;!e.auto||e.data&&"override"!==e.prefetch||e.reload()},methods:{getEndpoint:function(){var e=this,t=this.options;if(null==t)return new I;"string"==typeof t&&(t={url:t});var n=new $(h({},this.$chimeraOptions,{},t));if(Object.values(O).forEach((function(t){n.on(t,(function(){return e.$emit(t,n)}))})),!this._server&&n.key&&n.prefetch&&this._ssrContext){var r=this._ssrContext[n.key];r&&(r.prefetched=!0),Object.assign(n,r)}return n}}},D=function(){function e(t){i(this,e),this.expiration=t||6e4,this._store={}}return s(e,[{key:"setItem",value:function(e,t,n){this._store[e]={expiration:Date.now()+(n||this.expiration),value:t}}},{key:"getItem",value:function(e){var t=this._store[e];return t&&t.value&&Date.now()<=t.expiration?t.value:(this.removeItem(e),null)}},{key:"removeItem",value:function(e){delete this._store[e]}},{key:"keys",value:function(){return Object.keys(this._store)}},{key:"all",value:function(){var e=this;return this.keys().reduce((function(t,n){return t[n]=e._store[n],t}),{})}},{key:"length",value:function(){return this.keys().length}},{key:"clear",value:function(){this._store={}}}]),e}(),q=function(e){function t(e,n){var r,o=arguments.length>2&&void 0!==arguments[2]&&arguments[2];i(this,t),(r=y(this,f(t).call(this,n))).key=e;var s=o?"sessionStorage":"localStorage";if("undefined"==typeof window||!window[s])throw Error("StorageCache: ".concat(s," is not available."));r.storage=window[s];try{r._store=JSON.parse(r.storage.getItem(e))||{}}catch(e){r.clear(),r._store={}}return r}return l(t,e),s(t,[{key:"setItem",value:function(e,n,r){v(f(t.prototype),"setItem",this).call(this,e,n,r),this.storage.setItem(this.key,JSON.stringify(this._store))}},{key:"clear",value:function(){this.storage.removeItem(this.key)}}]),t}(D),N={baseURL:null,cache:null,debounce:50,deep:!0,keepData:!0,auto:"get",prefetch:null,prefetchTimeout:4e3,transformer:null,ssrContext:null};function U(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t=Object.assign({},N,t),e.mixin(R),e.component("chimera-endpoint",L);var n=t,r=n.deep,i=n.ssrContext,o=d(n,["deep","ssrContext"]);Object.assign($.prototype,o),Object.assign(A.prototype,{deep:r,ssrContext:i}),e.config.optionMergeStrategies.chimera=function(e,t,n){if(!e)return t;if(!t)return e;"function"==typeof t&&(t=t.call(n)),"function"==typeof e&&(e=e.call(n));var r=Object.assign({},e,t);return e.$options&&t.$options&&(r.$options=Object.assign({},e.$options,t.$options)),r}}e.CANCEL="cancel",e.ERROR="error",e.LOADING="loading",e.MemoryCache=D,e.SUCCESS="success",e.StorageCache=q,e.TIMEOUT="timeout",e.default=U,e.install=U,Object.defineProperty(e,"__esModule",{value:!0})}));
