!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vue"),require("axios")):"function"==typeof define&&define.amd?define(["exports","vue","axios"],t):t((e=e||self)["vue-chimera"]={},e.vue,e.Axios)}(this,function(e,t,r){"use strict";function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function i(){return(i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(e[s]=r[s])}return e}).apply(this,arguments)}function n(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},i=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),i.forEach(function(t){s(e,t,r[t])})}return e}function o(e,t){if(null==e)return{};var r,s,i=function(e,t){if(null==e)return{};var r,s,i={},n=Object.keys(e);for(s=0;s<n.length;s++)r=n[s],t.indexOf(r)>=0||(i[r]=e[r]);return i}(e,t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);for(s=0;s<n.length;s++)r=n[s],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}function a(e){return"object"==typeof e&&"[object Object]"===Object.prototype.toString(e)}function c(e){return e}t=t&&t.hasOwnProperty("default")?t.default:t,r=r&&r.hasOwnProperty("default")?r.default:r;var h=(e,t,r)=>{if(!Number.isFinite(t))throw new TypeError("Expected `wait` to be a finite number");let s,i;r=r||{};let n=[];return function(){const o=this,a=arguments;return new Promise(c=>{const h=r.leading&&!i;clearTimeout(i),i=setTimeout(()=>{i=null;const t=r.leading?s:e.apply(o,a);for(c of n)c(t);n=[]},t),h?(s=e.apply(o,a),c(s)):n.push(c)})}};const{CancelToken:l}=r,u="success",f="error",d="cancel",p="loading",m="timeout";class y{constructor(e,t){"string"==typeof e&&(e={url:e});let{autoFetch:r,prefetch:s,cache:i,debounce:c,transformer:u,axios:f,key:d,interval:p}=e,m=o(e,["autoFetch","prefetch","cache","debounce","transformer","axios","key","interval"]);if(m.method=(m.method||"get").toLowerCase(),this.autoFetch="string"==typeof r?r.toLowerCase()===m.method:Boolean(s),this.key=d,this.prefetch="boolean"==typeof s?s:this.autoFetch,this.cache=i,this.axios=f,this.fetchDebounced=h(this.fetch.bind(this),c,{leading:!0}),this._interval=p,this.setTransformer(u),m.data&&console.warn('[Chimera]: Do not use "params" key inside resource options, use data instead'),"params"in e&&!a(e.params))throw new Error("[Chimera]: Parameters is not a plain object");if("get"!==m.method&&(m.data=m.params,delete m.params),this.requestConfig=n({},m,{cancelToken:new l(e=>{this._canceler=e})}),this._listeners={},this.prefetched=!1,a(e.on))for(let t in e.on)this.on(t,e.on[t]);this.setInitial(t)}setTransformer(e){if("function"==typeof e)this.responseTransformer=e,this.errorTransformer=e;else if(a("object")){const{response:t,error:r}=e;this.responseTransformer=t||c,this.errorTransformer=r||c}else this.responseTransformer=c,this.errorTransformer=c}setInitial(e){Object.assign(this,function(...e){let t=Object.assign(...e);return Object.keys(e[0]).reduce((e,r)=>(e[r]=t[r],e),{})}({loading:!1,status:null,data:null,headers:null,error:null,lastLoaded:null},e||{}))}on(e,t){let r=this._listeners[e]||[];return r.push(t),this._listeners[e]=r,this}emit(e){(this._listeners[e]||[]).forEach(t=>{t(this,e)})}fetch(e,t,s){return new Promise((i,n)=>{if(this.cache&&!e){let e=this.getCache();if(e)return this.setByResponse(e),i(e)}this.loading=!0,this.emit(p);let{requestConfig:o}=this;if(a(s)&&(o=Object.assign({},o,(a(s),{}))),a(t)){const e="get"===o.method?"params":"data";o[e]=Object.assign(o[e],t)}this.axios.request(o).then(e=>{this.setByResponse(e),this.setCache(e),this.emit(u),i(e)}).catch(e=>{this.setByResponse(e.response),r.isCancel(e)?this.emit(d):e.message&&!e.response&&-1!==e.message.indexOf("timeout")?this.emit(m):this.emit(f),n(e)}).finally(()=>{this.loading=!1})})}reload(e){return this.fetchDebounced(e)}send(e,t){return this.fetchDebounced(!0,e,t)}cancel(e){e&&(this.data=null),"function"==typeof this._canceler&&this._canceler(),this.requestConfig.cancelToken=new l(e=>{this._canceler=e})}getCacheKey(){return this.key?this.key:("undefined"!=typeof window&&"undefined"!=typeof btoa?window.btoa:e=>e)(this.requestConfig.url+this.requestConfig.params+this.requestConfig.data+this.requestConfig.method)}getCache(){return this.cache?this.cache.getItem(this.getCacheKey()):void 0}setCache(e){this.cache&&this.cache.setItem(this.getCacheKey(),e)}deleteCache(){this.cache&&this.cache.removeItem(this.getCacheKey())}setByResponse(e){e=e||{};const t="2"===String(e.status).charAt(0);this.status=e.status,this.headers=e.headers||{},this.lastLoaded=new Date,this.data=t?this.responseTransformer(e.data,this):null,this.error=t?null:this.errorTransformer(e.data,this)}startInterval(e){if("number"!=typeof e)throw new Error("[Chimera]: interval should be number");"undefined"!=typeof process&&process.server||(this._interval=e,this.stopInterval(),this._interval_id=setInterval(()=>this.reload(!0),this._interval),this.looping=!0)}stopInterval(){this._interval_id&&(clearInterval(this._interval_id),this.looping=!1,this._interval_id=null,this._interval=!1)}toObj(){const e={};return["loading","status","data","headers","error","lastLoaded","prefetched"].forEach(t=>{e[t]=this[t]}),e}toString(){return JSON.stringify(this.toObj())}}class b extends y{fetch(e){return Promise.reject(new Error("Null Resource"))}cancel(){}}class g{constructor(e,t,s){let n=i({},s);this._vm=e,this._watchers=[],this._axios=n.axios=function(e){if(e instanceof r)return e;if(e&&"function"==typeof e.$request)return e;if(a(e))return r.create(e);if("function"==typeof e){if("function"==typeof e.request)return e;let t=e();if(t instanceof r)return t}return r}(n.axios),this._options=n,this._resources=t}init(){const e=this._resources=Object.assign({},this._resources);for(let t in e){if("$"===t.charAt(0))continue;let r=e[t];"function"==typeof r?this._watchers.push(this._vm.$watch(()=>r.call(this._vm),(e,r)=>this.updateResource(t,e,r),{immediate:!0,deep:!0})):e[t]=this.resourceFrom(r,t),Object.defineProperty(this._vm,t,{get:()=>e[t],configurable:!0,enumerable:!0})}Object.defineProperty(e,"$cancelAll",{value:this.cancelAll.bind(this)}),Object.defineProperty(e,"$axios",{get:()=>this._axios}),Object.defineProperty(e,"$loading",{get(){return!!Object.values(this).find(Boolean)}})}updateResource(e,t,r){const s=this._resources[e],i=this.resourceFrom(t,e);r&&r.keepData&&i.setInitial(s),r&&s&&(s.stopInterval(),i.lastLoaded=s.lastLoaded),i.prefetch&&i.reload(),this._resources[e]=i}resourceFrom(e,t){return null==e?new b:("string"==typeof e&&(e={url:e}),new y(Object.assign(Object.create(this._options),e)))}cancelAll(){Object.values(this._resources).forEach(e=>{e.cancel()})}destroy(){const e=this._vm;this.cancelAll(),delete e._chimera}}var _=(e={})=>({beforeCreate(){const t=this.$options;let r;if(!t.chimera||t._chimera)return;if("function"==typeof t.chimera&&(t.chimera=t.chimera.call(this)),t.chimera instanceof g)r=t.chimera;else if(a(t.chimera)){const s=t.chimera,{$options:i}=s,a=o(s,["$options"]);r=new g(this,a,n({},e,i))}const s="undefined"!=typeof process&&process.server&&this.$ssrContext?this.$ssrContext.nuxt:"undefined"!=typeof window?window.__NUXT__:null;if(r&&s&&s.chimera)try{if(this.$router){let e=this.$router.match(this.$router.currentRoute.fullPath);(e?e.matched:[]).forEach((e,t)=>{let i=s.chimera[t];i&&Object.keys(r.resources).forEach(e=>{let t=r.resources[e],s=i[e];t&&s&&s._data&&["_data","_status","_headers","ssrPrefetched","_lastLoaded"].forEach(e=>{t[e]=s[e]})})})}}catch(e){}this._chimera=r},data(){return{$chimera:this._chimera?this._chimera._resources:null}},created(){this._chimera&&this._chimera.init()}});const O={options:{axios:null,cache:null,debounce:50,autoFetch:"get",prefetch:null,prefetchTimeout:4e3,transformer:null},install(e,t={}){Object.keys(t).forEach(e=>{e in this.options&&(this.options[e]=t[e])}),e.prototype.hasOwnProperty("$chimera")||Object.defineProperty(e.prototype,"$chimera",{get(){return this._chimera?this._chimera._resources:null}}),e.mixin(_(this.options))},NuxtPlugin:function(){this.options=this.options||{};const e=this.options;return function({beforeNuxtRender:t,isDev:r,$axios:s}){if(!t)return;const i=[];t((...t)=>new Promise((n,a)=>{(async function({Components:t,nuxtState:n}){n.chimera=n.chimera||{};for(let a=0,c=t.length;a<c;a++){let c=t[a],h=c.options?c.options.chimera:null;if("function"==typeof h&&(s&&!c.$axios&&(c.$axios=s),h=h.bind(c)()),!h)continue;const l={},{$options:u}=h,f=o(h,["$options"]),d=Object.assign({},e,u);d.axios||(d.axios=s);for(let e in f){let t=f[e];if(t&&"function"!=typeof t){if(t=t&&t._data?t:y.from(t,d),i.push(t.cancel.bind(t)),!t.prefetch||!t.ssrPrefetch)continue;try{r&&console.log("  Prefetching: "+t.requestConfig.url);let e=await t.execute();t._data=e.data}catch(e){r&&console.error(e.message)}t.ssrPrefetched=!0,f[e]=l[e]=t}}Object.keys(l).length&&(n.chimera[a]=l)}})(...t).then(n).catch(a),setTimeout(a,e.ssrPrefetchTimeout,new Error("  SSR Prefetch Timeout."))}).catch(e=>{for(let e of i)"function"==typeof e&&e();r&&console.error(e.message)}))}}};let w=null;"undefined"!=typeof window?w=window.Vue:"undefined"!=typeof global&&(w=global.Vue),w&&w.use(O,O.options),e.EVENT_CANCEL=d,e.EVENT_ERROR=f,e.EVENT_LOADING=p,e.EVENT_SUCCESS=u,e.EVENT_TIMEOUT=m,e.default=O,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=vue-chimera.min.js.map
