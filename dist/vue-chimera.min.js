!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("axios")):"function"==typeof define&&define.amd?define(["exports","axios"],t):t((e=e||self)["vue-chimera"]={},e.Axios)}(this,function(e,t){"use strict";function s(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function r(){return(r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(e[r]=s[r])}return e}).apply(this,arguments)}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},i=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),i.forEach(function(t){s(e,t,r[t])})}return e}function o(e,t){if(null==e)return{};var s,r,i=function(e,t){if(null==e)return{};var s,r,i={},o=Object.keys(e);for(r=0;r<o.length;r++)s=o[r],t.indexOf(s)>=0||(i[s]=e[s]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)s=o[r],t.indexOf(s)>=0||Object.prototype.propertyIsEnumerable.call(e,s)&&(i[s]=e[s])}return i}function n(e){return"object"==typeof e&&"[object Object]"===Object.prototype.toString(e)}t=t&&t.hasOwnProperty("default")?t.default:t;const a=(e,t)=>t in(e||{});function h(e){return e}var c=(e,t,s)=>{if(!Number.isFinite(t))throw new TypeError("Expected `wait` to be a finite number");let r,i;s=s||{};let o=[];return function(){const n=this,a=arguments;return new Promise(h=>{const c=s.leading&&!i;clearTimeout(i),i=setTimeout(()=>{i=null;const t=s.leading?r:e.apply(n,a);for(h of o)h(t);o=[]},t),c?(r=e.apply(n,a),h(r)):o.push(h)})}};const{CancelToken:l}=t,u="success",f="error",d="cancel",p="loading",m="timeout",y={loading:!1,status:null,data:null,headers:null,error:null,lastLoaded:null};class _{constructor(e,t){"string"==typeof e&&(e={url:e});let{autoFetch:s,prefetch:r,cache:a,debounce:h,transformer:u,axios:f,key:d,interval:p}=e,m=o(e,["autoFetch","prefetch","cache","debounce","transformer","axios","key","interval"]);if(m.method=(m.method||"get").toLowerCase(),this.autoFetch="string"==typeof s?s.toLowerCase()===m.method:Boolean(s),this.key=d,this.prefetch=null!=r?r:this.autoFetch,this.cache=a,this.axios=f,this.fetchDebounced=c(this.fetch.bind(this),h,{leading:!0}),this.setTransformer(u),m.data&&console.warn('[Chimera]: Do not use "params" key inside resource options, use data instead'),"get"!==m.method&&(m.data=m.params,delete m.params),this.request=i({},m,{cancelToken:new l(e=>{this._canceler=e})}),this._listeners={},this.prefetched=!1,n(e.on))for(let t in e.on)this.on(t,e.on[t]);t&&Object.assign(this,y,t)}setTransformer(e){if("function"==typeof e)this.responseTransformer=e,this.errorTransformer=e;else if(n("object")){const{response:t,error:s}=e;this.responseTransformer=t||h,this.errorTransformer=s||h}else this.responseTransformer=h,this.errorTransformer=h}on(e,t){let s=this._listeners[e]||[];return s.push(t),this._listeners[e]=s,this}emit(e){(this._listeners[e]||[]).forEach(t=>{t(this,e)})}fetch(e,s,r){return new Promise((i,o)=>{if(this.cache&&!e){let e=this.getCache();if(e)return this.setByResponse(e),i(e)}this.loading=!0,this.emit(p);let{request:a}=this;if(n(r)&&(a=Object.assign({},a,(n(r),{}))),n(s)){const e="get"===a.method?"params":"data";a[e]=Object.assign(a[e],s)}this.axios.request(a).then(e=>{this.setByResponse(e),this.setCache(e),this.emit(u),i(e)}).catch(e=>{this.setByResponse(e.response),t.isCancel(e)?this.emit(d):e.message&&!e.response&&-1!==e.message.indexOf("timeout")?this.emit(m):this.emit(f),o(e)}).finally(()=>{this.loading=!1})})}reload(e){return this.fetchDebounced(e)}send(e,t){return this.fetchDebounced(!0,e,t)}cancel(e){e&&(this.data=null),"function"==typeof this._canceler&&this._canceler(),this.request.cancelToken=new l(e=>{this._canceler=e})}getCacheKey(){return this.key?this.key:("undefined"!=typeof window&&"undefined"!=typeof btoa?window.btoa:e=>e)(this.request.url+this.request.params+this.request.data+this.request.method)}getCache(){return this.cache?this.cache.getItem(this.getCacheKey()):void 0}setCache(e){this.cache&&this.cache.setItem(this.getCacheKey(),e)}deleteCache(){this.cache&&this.cache.removeItem(this.getCacheKey())}setByResponse(e){e=e||{};const t="2"===String(e.status).charAt(0);this.status=e.status,this.headers=e.headers||{},this.lastLoaded=new Date,this.data=t?this.responseTransformer(e.data,this):null,this.error=t?null:this.errorTransformer(e.data,this)}startInterval(e){if("number"!=typeof e)throw new Error("[Chimera]: interval should be number");"undefined"!=typeof process&&process.server||(this._interval=e,this.stopInterval(),this._interval_id=setInterval(()=>this.reload(!0),this._interval),this.looping=!0)}stopInterval(){this._interval_id&&(clearInterval(this._interval_id),this.looping=!1,this._interval_id=null,this._interval=!1)}toObj(){const e={};return Object.keys(y).forEach(t=>{e[t]=this[t]}),e}toString(){return JSON.stringify(this.toObj())}get params(){return"get"===this.request.method?this.request.params:this.request.data}get url(){return this.request.url}get method(){return this.request.method}}class g extends _{fetch(e){return Promise.reject(new Error("Null Resource"))}cancel(){}}const b=e=>e.autoFetch&&(!e.prefetched||"override"===e.prefetch);class v{constructor(e,s,i){let h=r({},s),{deep:c,ssrContext:l}=i,u=o(i,["deep","ssrContext"]);this._vm=e,this._watchers=[],this._axios=u.axios=function(e){if(e instanceof t)return e;if(e&&"function"==typeof e.$request)return e;if(n(e))return t.create(e);if("function"==typeof e){if("function"==typeof e.request)return e;let s=e();if(s instanceof t)return s}return t}(u.axios),this._options=u,this._deep=c,this._ssrContext=l,this._server=e.$isServer;const f={immediate:!0,deep:this._deep,sync:!0};for(let e in h){if("$"===e.charAt(0))continue;let t=h[e];"function"==typeof t?this._watchers.push([()=>t.call(this._vm),(t,s)=>this.updateResource(e,t,s),f]):(t=h[e]=this.resourceFrom(t),!this._server&&b(t)&&t.reload())}Object.defineProperty(h,"$cancelAll",{value:this.cancelAll.bind(this)}),Object.defineProperty(h,"$axios",{get:()=>this._axios}),Object.defineProperty(h,"$loading",{get(){return!!Object.values(this).find(e=>!!e.loading)}}),this._resources=h;const d=this._vm.$options,p=d.computed=d.computed||{};Object.keys(h).forEach(e=>{a(p,e)||a(d.props,e)||a(d.methods,e)||(p[e]=(()=>this._resources[e]))})}init(){this._watchers=this._watchers.map(e=>this._vm.$watch(...e))}initServer(){this._vm.$_chimeraPromises=[],Object.values(this._resources).forEach(e=>{if(e.prefetch){if(!e.key)return void console.warn("[Chimera]: used prefetch with no key associated with resource!");this._vm.$_chimeraPromises.push(e.fetch(!0).catch(()=>null).then(()=>e))}})}updateResource(e,t,s){const r=this._resources[e],i=this.resourceFrom(t,s&&s.keepData?r.toObj():null);s&&r&&(r.stopInterval(),i.lastLoaded=r.lastLoaded),this._server||(t.interval&&i.startInterval(t.interval),console.log(i.prefetch),b(i)&&i.reload()),this._vm.$set(this._resources,e,i)}resourceFrom(e,t){if(null==e)return new g;"string"==typeof e&&(e={url:e}),n(e.on)&&Object.entries(e.on).forEach(([t,s])=>{"function"==typeof s&&(s=s.bind(this._vm)),"string"==typeof s&&(s=this._vm[s]),e.on[t]=s}),!this._server&&!t&&e.key&&this._ssrContext&&(t=this.getContext()[e.key])&&(t.prefetched=!0);const s=Object.create(this._options);return new _(Object.assign(s,e),t)}cancelAll(){Object.values(this._resources).forEach(e=>{e.cancel()})}getContext(){if("string"==typeof this._ssrContext)try{let e=window;this._ssrContext.split(".").forEach(t=>{e=e[t]}),this._ssrContext=e}catch(e){}return this._ssrContext||{}}destroy(){const e=this._vm;this.cancelAll(),delete e._chimera}}var w=(e={})=>({beforeCreate(){const t=this.$options;let s;if(t.chimera&&!t._chimera){if("function"==typeof t.chimera&&(t.chimera=t.chimera.call(this)),t.chimera instanceof v)s=t.chimera;else if(n(t.chimera)){const r=t.chimera,{$options:n}=r,a=o(r,["$options"]);s=new v(this,a,i({},e,n))}this._chimera=s,Object.defineProperty(this,"$chimera",{get:()=>s._resources})}},data(){return this._chimera?{$chimera:this._chimera._resources}:{}},created(){this._chimera&&(this._chimera.init(),this.$isServer&&this._chimera.initServer())},serverPrefetch(...e){if(!this.$_chimeraPromises)return;const t=require("../ssr/index");return Promise.all(this.$_chimeraPromises).then(e=>{e.forEach(e=>{e&&t.addResource(e)})})}});class O{constructor(e){this.expiration=e||6e4,this._store={}}setItem(e,t,s){this._store[e]={expiration:Date.now()+(s||this.expiration),value:t}}getItem(e){let t=this._store[e];return t&&t.value&&Date.now()<=t.expiration?t.value:(console.log("sss"),this.removeItem(e),null)}removeItem(e){delete this._store[e]}keys(){return Object.keys(this._store)}all(){return this.keys().reduce((e,t)=>(e[t]=this._store.getItem(t),e),{})}length(){return this.keys().length}clearCache(){this._store={}}}const j={options:{axios:null,cache:null,debounce:50,deep:!0,keepData:!0,autoFetch:"get",prefetch:!1,prefetchTimeout:4e3,transformer:null,ssrContext:null},install(e,t={}){Object.keys(t).forEach(e=>{e in this.options&&(this.options[e]=t[e])}),e.mixin(w(this.options))}};let x=null;"undefined"!=typeof window?x=window.Vue:"undefined"!=typeof global&&(x=global.Vue),x&&x.use(j,j.options),e.EVENT_CANCEL=d,e.EVENT_ERROR=f,e.EVENT_LOADING=p,e.EVENT_SUCCESS=u,e.EVENT_TIMEOUT=m,e.MemoryCache=O,e.StorageCache=class extends O{constructor(e,t,s=!1){super(t),this.key=e;const r=s?"sessionStorage":"localStorage";if("undefined"==typeof window||!window[r])throw Error(`StorageCache: ${r} is not available.`);this.storage=window[r];try{this._store=JSON.parse(this.storage.getItem(e))||{}}catch(e){this.clearCache(),this._store={}}}setItem(e,t,s){super.setItem(e,t,s),this.storage.setItem(this.key,JSON.stringify(this._store))}clearCache(){this.storage.removeItem(this.key)}},e.default=j,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=vue-chimera.min.js.map
