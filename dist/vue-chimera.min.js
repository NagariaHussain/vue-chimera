!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("axios")):"function"==typeof define&&define.amd?define(["exports","axios"],t):t((e=e||self)["vue-chimera"]={},e.Axios)}(this,function(e,t){"use strict";var s="default"in t?t.default:t;function r(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function i(){return(i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(e[r]=s[r])}return e}).apply(this,arguments)}function n(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{},i=Object.keys(s);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(s).filter(function(e){return Object.getOwnPropertyDescriptor(s,e).enumerable}))),i.forEach(function(t){r(e,t,s[t])})}return e}function o(e,t){if(null==e)return{};var s,r,i=function(e,t){if(null==e)return{};var s,r,i={},n=Object.keys(e);for(r=0;r<n.length;r++)s=n[r],t.indexOf(s)>=0||(i[s]=e[s]);return i}(e,t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);for(r=0;r<n.length;r++)s=n[r],t.indexOf(s)>=0||Object.prototype.propertyIsEnumerable.call(e,s)&&(i[s]=e[s])}return i}var a=(e,t,s)=>{if(!Number.isFinite(t))throw new TypeError("Expected `wait` to be a finite number");let r,i;s=s||{};let n=[];return function(){const o=this,a=arguments;return new Promise(h=>{const c=s.leading&&!i;clearTimeout(i),i=setTimeout(()=>{i=null;const t=s.leading?r:e.apply(o,a);for(h of n)h(t);n=[]},t),c?(r=e.apply(o,a),h(r)):n.push(h)})}};const h="success",c="error",l="cancel",u="loading",d="timeout";var p=Object.freeze({SUCCESS:h,ERROR:c,CANCEL:l,LOADING:u,TIMEOUT:d});function f(e){return"object"==typeof e&&e&&"[object Object]"===Object.prototype.toString(e)}function m(...e){let t=Object.assign({},...e);return Object.keys(e[0]).reduce((e,s)=>(e[s]=t[s],e),{})}const y=(e,t)=>t in(e||{});function v(e){try{let t=window;return e.split(".").forEach(e=>{t=t[e]}),t}catch(e){}return null}function _(e){return e}function b(e,...t){console.warn("[Chimera]: "+e,...t)}var g={request(e,r){var i;return(r.axios?"function"==typeof(i=r.axios)?"function"==typeof i.request?i:i():f(i)?s.create(i):s:s).request(n({},e,{cancelToken:new t.CancelToken(e=>{r._canceler=e})}))},cancel(e){"function"==typeof e._canceler&&e._canceler(),e._canceler=null},isCancelError:e=>s.isCancel(e)};const O={status:null,data:null,headers:null,error:null,lastLoaded:null},w={url:null,baseURL:null,method:"get",params:null,timeout:0,headers:null};class C{constructor(e,t){if("string"==typeof e&&(e={url:e,key:e}),!e)throw b("Invalid options",e),new Error("[Chimera]: invalid options");let{debounce:s,transformer:r,interval:i,on:n}=e,h=o(e,["debounce","transformer","interval","on"]);if(h.method=(h.method||"get").toLowerCase(),this.fetchDebounced=!1!==s?a(this.fetch.bind(this),s||50,{leading:!0}):this.fetch,this.setTransformer(r),this.prefetched=!1,this.loading=!1,this.listeners={},f(n))for(const e in n)this.on(e,n[e]);Object.assign(this,h),"string"==typeof this.auto?this.auto=this.auto.toLowerCase()===this.method:this.auto=Boolean(this.auto),this.prefetch=null!=this.prefetch?this.prefetch:this.auto,Object.assign(this,O,t||{}),this.http=g,i&&this.startInterval(i)}setTransformer(e){if("function"==typeof e)this.responseTransformer=e,this.errorTransformer=e;else if(f(e)){const{response:t,error:s}=e;this.responseTransformer=t||_,this.errorTransformer=s||_}else this.responseTransformer=_,this.errorTransformer=_}on(e,t){let s=this.listeners[e]||[];return s.push(t),this.listeners[e]=s,this}emit(e){(this.listeners[e]||[]).forEach(t=>{t(this,e)})}fetch(e,t){return new Promise((s,r)=>{if(this.cache&&!e){let e=this.getCache();if(e)return this.setResponse(e),s(e)}this.loading=!0,this.emit(u);let{request:i}=this;f(t)&&(t.params&&(t.params=Object.assign({},i.params,t.params)),i=Object.assign({},i,t)),this.http.request(i,this).then(e=>{this.loading=!1,this.setResponse(e),this.setCache(e),this.emit(h),s(e)}).catch(e=>{this.loading=!1,this.setResponse(e.response),this.http.isCancelError(e)?this.emit(l):(e.message&&!e.response&&-1!==e.message.indexOf("timeout")&&this.emit(d),this.emit(c)),r(e)})})}reload(e){return this.fetchDebounced(e)}send(e){return this.fetchDebounced(!0,{params:e})}cancel(){this.http.cancel(this)}getCacheKey(){return this.key?this.key:("undefined"!=typeof window&&"undefined"!=typeof btoa?window.btoa:e=>e)(Object.values(this.request).join(":"))}getCache(){return this.cache?this.cache.getItem(this.getCacheKey()):void 0}setCache(e){this.cache&&this.cache.setItem(this.getCacheKey(),e)}deleteCache(){this.cache&&this.cache.removeItem(this.getCacheKey())}setResponse(e){e=e||{};const t="2"===String(e.status).charAt(0);this.status=e.status,this.headers=e.headers||{},this.lastLoaded=new Date,this.data=t?this.responseTransformer(e.data,this):null,this.error=t?null:this.errorTransformer(e.data,this)}startInterval(e){if("number"!=typeof e)throw new Error("[Chimera]: interval should be number");"undefined"!=typeof process&&process.server||(this._interval=e,this.stopInterval(),this._interval_id=setInterval(()=>this.reload(!0),this._interval))}stopInterval(){this._interval_id&&(clearInterval(this._interval_id),this._interval_id=null,this._interval=!1)}get looping(){return!!this._interval}get request(){return m(w,this,{baseURL:this.baseURL,timeout:this.timeout,headers:this.headers})}get response(){return m(O,this)}toString(){return JSON.stringify(this.response)}}class j extends C{constructor(){super({})}fetch(e){return Promise.reject(new Error("[Chimera]: Fetching null endpoint"))}cancel(){}}const E=e=>e.auto&&(!e.prefetched||"override"===e.prefetch);class x{constructor(e,t,s){let r=i({},t),{deep:n,ssrContext:a}=s,h=o(s,["deep","ssrContext"]);this._vm=e,this._watchers=[],this.LocalEndpoint=class extends C{},Object.assign(this.LocalEndpoint.prototype,h),this._deep=n,this._ssrContext=v(a),this._server=e.$isServer;const c={immediate:!0,deep:this._deep,sync:!0};for(let e in r){if("$"===e.charAt(0)){delete r[e];continue}let t=r[e];"function"==typeof t?this._watchers.push([()=>t.call(this._vm),(t,s)=>this.updateEndpoint(e,t,s),c]):(t=r[e]=this.endpointFrom(t),this._server||E(t)&&t.reload())}Object.defineProperty(r,"$cancelAll",{value:()=>this.cancelAll()}),Object.defineProperty(r,"$loading",{get(){return!!Object.values(this).find(e=>!!e.loading)}}),this.endpoints=r;const l=this._vm.$options,u=l.computed=l.computed||{};Object.keys(r).forEach(e=>{y(u,e)||y(l.props,e)||y(l.methods,e)||(u[e]=(()=>this.endpoints[e]))})}init(){this._watchers=this._watchers.map(e=>this._vm.$watch(...e))}initServer(){this._vm.$_chimeraPromises=[],Object.values(this.endpoints).forEach(e=>{if(e.prefetch){if(!e.key)return void b("used prefetch with no key associated with endpoint!");this._vm.$_chimeraPromises.push(e.fetch(!0,{timeout:e.prefetchTimeout}).then(()=>e).catch(()=>null))}})}updateEndpoint(e,t,s){const r=this.endpoints[e],i=this.endpointFrom(t,s&&s.keepData?r.toObj():null);s&&r&&(r.stopInterval(),i.lastLoaded=r.lastLoaded),this._server||E(i)&&i.reload(),this._vm.$set(this.endpoints,e,i)}endpointFrom(e,t){if(null==e)return new j;"string"==typeof e&&(e={url:e}),f(e.on)&&Object.entries(e.on).forEach(([t,s])=>{"function"==typeof s&&(s=s.bind(this._vm)),"string"==typeof s&&(s=this._vm[s]),e.on[t]=s});const s=new this.LocalEndpoint(e,t);return!this._server&&!t&&s.key&&s.prefetch&&this._ssrContext&&((t=this._ssrContext[e.key])&&(t.prefetched=!0),Object.assign(s,t)),s}cancelAll(){Object.values(this.endpoints).forEach(e=>{e.cancel()})}destroy(){const e=this._vm;this.cancelAll(),Object.values(this.endpoints).forEach(e=>{e.stopInterval()}),delete e._chimera}}var $=(e={})=>({beforeCreate(){const t=this.$options;let s;if(t.chimera&&!t._chimera){if("function"==typeof t.chimera&&(t.chimera=t.chimera.call(this)),!f(t.chimera))throw new Error("[Chimera]: chimera options should be an object or a function that returns object");{const r=t.chimera,{$options:i}=r,a=o(r,["$options"]);s=new x(this,a,n({},e,i))}this._chimera=s,Object.prototype.hasOwnProperty.call(this,"$chimera")||Object.defineProperty(this,"$chimera",{get:()=>s.endpoints})}},data(){return this._chimera?{$chimera:this._chimera.endpoints}:{}},created(){this._chimera&&(this._chimera.init(),this.$isServer&&this._chimera.initServer())},beforeDestroy(){this._chimera&&this._chimera.destroy()},serverPrefetch(...e){if(!this.$_chimeraPromises)return;const t=require("../ssr/index");return Promise.all(this.$_chimeraPromises).then(e=>{e.forEach(e=>{e&&t.addEndpoint(e)})})}});const S=function(e,t,s,r,i,n,o,a,h,c){"boolean"!=typeof o&&(h=a,a=o,o=!1);const l="function"==typeof s?s.options:s;let u;if(e&&e.render&&(l.render=e.render,l.staticRenderFns=e.staticRenderFns,l._compiled=!0,i&&(l.functional=!0)),r&&(l._scopeId=r),n?(u=function(e){(e=e||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(e=__VUE_SSR_CONTEXT__),t&&t.call(this,h(e)),e&&e._registeredComponents&&e._registeredComponents.add(n)},l._ssrRegister=u):t&&(u=o?function(e){t.call(this,c(e,this.$root.$options.shadowRoot))}:function(e){t.call(this,a(e))}),u)if(l.functional){const e=l.render;l.render=function(t,s){return u.call(s),e(t,s)}}else{const e=l.beforeCreate;l.beforeCreate=e?[].concat(e,u):[u]}return s}({},void 0,{inheritAttrs:!1,props:{options:{type:[Object,String],required:!0},tag:{type:String,default:null}},data(){return{endpoint:this.getEndpoint()}},beforeCreate(){this._ssrContext=v(this.$chimeraOptions.ssrContext)},render(e){let t=this.$scopedSlots.default(this.endpoint);return t=Array.isArray(t)?t.concat(this.$slots.default):[t].concat(this.$slots.default),this.tag?e(this.tag,t):t[0]},created(){const e=this.endpoint;this.$isServer&&e.key&&(this.$_chimeraPromises=[e.fetch(!0).then(()=>e).catch(()=>null)])},mounted(){const e=this.endpoint;!e.auto||e.data&&"override"!==e.prefetch||e.reload()},methods:{getEndpoint(){let e=this.options;if(null==e)return new j;"string"==typeof e&&(e={url:e});const t=new C(n({},this.$chimeraOptions,e));if(Object.values(p).forEach(e=>{t.on(e,()=>this.$emit(e,t))}),!this._server&&t.key&&t.prefetch&&this._ssrContext){const e=this._ssrContext[t.key];e&&(e.prefetched=!0),Object.assign(t,e)}return t}}},void 0,void 0,void 0,!1,void 0,void 0,void 0);class I{constructor(e){this.expiration=e||6e4,this._store={}}setItem(e,t,s){this._store[e]={expiration:Date.now()+(s||this.expiration),value:t}}getItem(e){let t=this._store[e];return t&&t.value&&Date.now()<=t.expiration?t.value:(this.removeItem(e),null)}removeItem(e){delete this._store[e]}keys(){return Object.keys(this._store)}all(){return this.keys().reduce((e,t)=>(e[t]=this._store[t],e),{})}length(){return this.keys().length}clear(){this._store={}}}const k={options:{baseURL:null,cache:null,debounce:50,deep:!0,keepData:!0,auto:"get",prefetch:null,prefetchTimeout:4e3,transformer:null,ssrContext:null},install(e,t={}){t=m(this.options,t),e.mixin($(t)),e.component("chimera-endpoint",S),e.prototype.$chimeraOptions=t;const s=o(t,["deep","ssrContext"]);Object.assign(C.prototype,s)}};let T=null;"undefined"!=typeof window?T=window.Vue:"undefined"!=typeof global&&(T=global.Vue),T&&T.use(k,k.options),e.CANCEL=l,e.ERROR=c,e.LOADING=u,e.MemoryCache=I,e.SUCCESS=h,e.StorageCache=class extends I{constructor(e,t,s=!1){super(t),this.key=e;const r=s?"sessionStorage":"localStorage";if("undefined"==typeof window||!window[r])throw Error(`StorageCache: ${r} is not available.`);this.storage=window[r];try{this._store=JSON.parse(this.storage.getItem(e))||{}}catch(e){this.clear(),this._store={}}}setItem(e,t,s){super.setItem(e,t,s),this.storage.setItem(this.key,JSON.stringify(this._store))}clear(){this.storage.removeItem(this.key)}},e.TIMEOUT=d,e.default=k,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=vue-chimera.min.js.map
