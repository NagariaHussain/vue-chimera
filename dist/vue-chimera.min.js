var VueChimera=function(t,e){"use strict";var r="default"in e?e.default:e;function n(t){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function s(t,e,r){return e&&o(t.prototype,e),r&&o(t,r),t}function a(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function c(){return(c=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t}).apply(this,arguments)}function u(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function h(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?u(Object(r),!0).forEach((function(e){a(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):u(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function f(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&p(t,e)}function l(t){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function p(t,e){return(p=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function d(t,e){if(null==t)return{};var r,n,i=function(t,e){if(null==t)return{};var r,n,i={},o=Object.keys(t);for(n=0;n<o.length;n++)r=o[n],e.indexOf(r)>=0||(i[r]=t[r]);return i}(t,e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);for(n=0;n<o.length;n++)r=o[n],e.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(t,r)&&(i[r]=t[r])}return i}function y(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function v(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){if(!(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)))return;var r=[],n=!0,i=!1,o=void 0;try{for(var s,a=t[Symbol.iterator]();!(n=(s=a.next()).done)&&(r.push(s.value),!e||r.length!==e);n=!0);}catch(t){i=!0,o=t}finally{try{n||null==a.return||a.return()}finally{if(i)throw o}}return r}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function m(t){return function(t){if(Array.isArray(t)){for(var e=0,r=new Array(t.length);e<t.length;e++)r[e]=t[e];return r}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var b=(t,e,r)=>{if(!Number.isFinite(e))throw new TypeError("Expected `wait` to be a finite number");let n,i;r=r||{};let o=[];return function(){const s=this,a=arguments;return new Promise(c=>{const u=r.leading&&!i;clearTimeout(i),i=setTimeout(()=>{i=null;const e=r.leading?n:t.apply(s,a);for(c of o)c(e);o=[]},e),u?(n=t.apply(s,a),c(n)):o.push(c)})}};function g(t){return"object"===n(t)&&t&&"[object Object]"===Object.prototype.toString(t)}var O=function(t,e){return e in(t||{})};function j(t){return Object.keys(t).forEach((function(e){void 0===t[e]&&delete t[e]})),t}function _(t){try{var e=window;return t.split(".").forEach((function(t){e=e[t]})),e}catch(t){}return null}function w(t){return t}function k(t){for(var e,r=arguments.length,n=new Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];(e=console).warn.apply(e,["[Chimera]: "+t].concat(n))}function C(t){return"function"==typeof t?"function"==typeof t.request?t:t():g(t)?r.create(t):r}var E={request:function(t){var r,n=C(t.axios),i={url:(r=t).url,method:r.method,baseURL:r.baseURL,headers:r.requestHeaders,timeout:r.timeout};return j(i),i["get"!==(t.method||"get")?"data":"params"]=t.params,i.cancelToken=new e.CancelToken((function(e){t._canceler=e})),n.request(i).catch((function(t){throw Object.assign(t,t.response)}))},cancel:function(t){"function"==typeof t._canceler&&t._canceler(),t._canceler=null},isCancelError:function(t){return r.isCancel(t)},isTimeoutError:function(t){return t.message&&!t.response&&-1!==t.message.indexOf("timeout")}},x={status:null,data:null,headers:void 0,error:null,lastLoaded:void 0},P=function(){function t(e,r){if(i(this,t),"string"==typeof e&&(e={url:e,key:e}),!e)throw k("Invalid options",e),new Error("[Chimera]: invalid options");var n=e=this.options?this.constructor.applyDefaults(this.options,e):e,o=n.debounce,s=n.transformer,a=n.interval,c=n.headers,u=n.on,h=n.auto,f=n.prefetch,l=d(n,["debounce","transformer","interval","headers","on","auto","prefetch"]);if(l.method=(l.method||"get").toLowerCase(),this.fetchDebounced=!1!==o?b(this.fetch.bind(this),o||50,{leading:!0}):this.fetch,this.setTransformer(s),this.prefetched=!1,this.loading=!1,this.listeners=Object.create(null),g(u))for(var p in u)this.on(p,u[p]);Object.assign(this,l),this.requestHeaders=c,this.auto="string"==typeof h?h.toLowerCase()===l.method:!!h,this.prefetch=null!=f?f:this.auto,Object.assign(this,x,r||{}),a&&this.startInterval(a)}return s(t,[{key:"setTransformer",value:function(t){if("function"==typeof t)this.responseTransformer=t,this.errorTransformer=t;else if(g(t)){var e=t.response,r=t.error;this.responseTransformer=e||w,this.errorTransformer=r||w}else this.responseTransformer=w,this.errorTransformer=w}},{key:"on",value:function(t,e){return this.listeners[t]=(this.listeners[t]||[]).concat(e),this}},{key:"emit",value:function(t){var e=this;(this.listeners[t]||[]).forEach((function(r){r(e,t)}))}},{key:"fetch",value:function(t,e){var r=this;if(this.cache&&!t){var n=this.getCache();if(n)return this.setResponse(n,!0),Promise.resolve(n)}var i=this;return g(e)&&(i=Object.create(this),e.params&&(e.params=Object.assign({},i.params,e.params)),e.headers&&(e.requestHeaders=Object.assign({},i.requestHeaders,e.headers)),Object.assign(i,e)),this.loading=!0,this.emit("loading"),this.http.request(i).then((function(t){return r.loading=!1,r.setResponse(t,!0),r.setCache(t),r.emit("success"),t})).catch((function(t){if(r.loading=!1,r.setResponse(t,!1),!r.http.isCancelError(t))throw r.http.isTimeoutError&&r.emit("timeout"),r.emit("error"),t}))}},{key:"reload",value:function(t){return this.fetchDebounced(t)}},{key:"send",value:function(t){return this.fetch(!0,{params:t})}},{key:"cancel",value:function(t){this.loading&&(this.http.cancel(this),!t&&this.emit("cancel"))}},{key:"getCacheKey",value:function(){if(this.key)return this.key;throw new Error('[Chimera]: cannot use cache without "key" property')}},{key:"getCache",value:function(){return this.cache?this.cache.getItem(this.getCacheKey()):void 0}},{key:"setCache",value:function(t){this.cache&&this.cache.setItem(this.getCacheKey(),t)}},{key:"deleteCache",value:function(){this.cache&&this.cache.removeItem(this.getCacheKey())}},{key:"setResponse",value:function(t,e){t=t||{},this.status=t.status,this.data=e?this.responseTransformer(t.data,this):null,this.error=e?null:this.errorTransformer(t.data,this),this.headers=this.light?void 0:t.headers||{},this.lastLoaded=this.light?void 0:new Date}},{key:"startInterval",value:function(t){var e=this;if("number"!=typeof t)throw new Error("[Chimera]: interval should be number");"undefined"!=typeof process&&process.server||(this._interval=t,this.stopInterval(),this._interval_id=setInterval((function(){e.cancel(),e.reload(!0)}),this._interval))}},{key:"stopInterval",value:function(){this._interval_id&&(clearInterval(this._interval_id),this._interval_id=null,this._interval=!1)}},{key:"toString",value:function(){return JSON.stringify(this.response)}},{key:"looping",get:function(){return!!this._interval}},{key:"response",get:function(){return function(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];var n=Object.assign.apply(Object,[{}].concat(e));return Object.keys(e[0]).reduce((function(t,e){return t[e]=n[e],t}),{})}(x,this)}}],[{key:"applyDefaults",value:function(t,e){if(!t)return e;e=h({},e);var r=this.optionMergeStrategies;return Object.keys(t).forEach((function(n){e[n]=n in e&&r[n]?r[n](t[n],e[n]):n in e?e[n]:t[n]})),e}}]),t}();P.prototype.http=E;var S=P.optionMergeStrategies={};S.headers=S.params=S.transformers=function(t,e){return g(t)&&g(e)?h({},t,{},e):void 0===e?t:e},S.on=function(t,e){var r=h({},t||{});return Object.entries(e||{}).forEach((function(t){var e=v(t,2),n=e[0],i=e[1],o=r[n];r[n]=o?[].concat(o).concat(i):i})),r};var $=function(t){function e(){return i(this,e),y(this,l(e).call(this,{}))}return f(e,t),s(e,[{key:"fetch",value:function(t){return Promise.reject(new Error("[Chimera]: Fetching null endpoint"))}},{key:"cancel",value:function(){}}]),e}(P),T=function(t){return t.auto&&(!t.prefetched||"override"===t.prefetch)},A=function(){function t(e,r,n){var o=this,s=c({},r);i(this,t),this._vm=e,this._watchers=[];var a=n||{},u=a.deep,h=a.ssrContext,p=a.axios,v=d(a,["deep","ssrContext","axios"]),m=this.LocalEndpoint=function(t){function e(){return i(this,e),y(this,l(e).apply(this,arguments))}return f(e,t),e}(P);I(v,this._vm),m.prototype.options=m.applyDefaults(m.prototype.options,v),Object.assign(this,j({deep:u,ssrContext:h,axios:p})),m.prototype.axios=C("function"!=typeof this.axios||this.axios.request?this.axios:this.axios.call(e)),this._ssrContext=_(this.ssrContext),this._server=e.$isServer;var b={immediate:!0,deep:this._deep,sync:!0},g=function(t){if("$"===t.charAt(0))return delete s[t],"continue";var r=s[t];"function"==typeof r?o._watchers.push([function(){return r.call(e)},function(e,r){return o.updateEndpoint(t,e,r)},b]):(r=s[t]=o.endpointFrom(r),o._server||T(r)&&r.reload())};for(var O in s)g(O);Object.defineProperty(s,"$cancelAll",{value:function(){return o.cancelAll()}}),Object.defineProperty(s,"$loading",{get:function(){return!!Object.values(this).find((function(t){return!!t.loading}))}}),this.endpoints=s}return s(t,[{key:"init",value:function(){var t=this;this._watchers=this._watchers.map((function(e){var r;return(r=t._vm).$watch.apply(r,m(e))}))}},{key:"initServer",value:function(){var t=this;this._vm.$_chimeraPromises=[],Object.values(this.endpoints).forEach((function(e){if(e.auto&&e.prefetch){if(!e.key)return void k("used prefetch with no key associated with endpoint!");t._vm.$_chimeraPromises.push(e.fetch(!0,{timeout:e.prefetchTimeout}).then((function(){return e})).catch((function(){return null})))}}))}},{key:"updateEndpoint",value:function(t,e,r){var n=this.endpoints[t],i=this.endpointFrom(e,n&&n.keepData?n.response:null);r&&n&&(n.stopInterval(),n.cancel(!0),i.lastLoaded=n.lastLoaded),this._server||T(i)&&i.reload(),this._vm.$set(this.endpoints,t,i)}},{key:"endpointFrom",value:function(t,e){if(null==t)return new $;"string"==typeof t&&(t={url:t}),I(t,this._vm);var r=new(this.LocalEndpoint||P)(t,e);return!this._server&&!e&&r.key&&r.prefetch&&this._ssrContext&&((e=this._ssrContext[t.key])&&(e.prefetched=!0),Object.assign(r,e)),r}},{key:"cancelAll",value:function(){Object.values(this.endpoints).forEach((function(t){t.cancel()}))}},{key:"destroy",value:function(){var t=this._vm;this.cancelAll(),Object.values(this.endpoints).forEach((function(t){t.stopInterval()})),delete t._chimera}}]),t}();function I(t,e){if(g(t.on)){var r=function(t){return"function"==typeof t&&(t=t.bind(e)),"string"==typeof t&&(t=e[t]),t};Object.entries(t.on).forEach((function(e){var n=v(e,2),i=n[0],o=n[1];t.on[i]=Array.isArray(o)?o.map(r):r(o)}))}}var D={beforeCreate:function(){var t,e=this,r=this.$options;if(r.chimera&&!r._chimera){if("function"==typeof r.chimera&&(r.chimera=r.chimera.call(this)),!g(r.chimera))throw new Error("[Chimera]: chimera options should be an object or a function that returns object");var n=r.chimera,i=n.$options,o=d(n,["$options"]);t=new A(this,o,i),Object.prototype.hasOwnProperty.call(this,"$chimera")||Object.defineProperty(this,"$chimera",{get:function(){return t.endpoints}}),Object.keys(t.endpoints).forEach((function(t){O(r.computeds,t)||O(r.props,t)||O(r.methods,t)||Object.defineProperty(e,t,{get:function(){return e.$chimera[t]},enumerable:!0,configurable:!0})})),this._chimera=t}},data:function(){return this._chimera?{$chimera:this._chimera.endpoints}:{}},created:function(){this._chimera&&(this._chimera.init(),this.$isServer&&this._chimera.initServer())},beforeDestroy:function(){this._chimera&&this._chimera.destroy()},serverPrefetch:function(){if(this.$_chimeraPromises){var t=require("../ssr/index");return Promise.all(this.$_chimeraPromises).then((function(e){e.forEach((function(e){e&&t.addEndpoint(e)}))}))}}},q={inheritAttrs:!1,props:{options:{type:[Object,String]},tag:{type:String,default:null},ssrContext:{type:String,default:null}},data:function(){return{endpoint:this.getEndpoint()}},render:function(t){var e=this.$scopedSlots.default(this.endpoint);return e=Array.isArray(e)?e.concat(this.$slots.default):[e].concat(this.$slots.default),this.tag?t(this.tag,e):e[0]},created:function(){var t=this.endpoint;this.$isServer&&t.key&&(this.$_chimeraPromises=[t.fetch(!0).then((function(){return t})).catch((function(){return null}))])},mounted:function(){var t=this.endpoint;!t.auto||t.data&&"override"!==t.prefetch||t.reload()},methods:{getEndpoint:function(){var t=this,e=this.options;if(null==e)return new $;"string"==typeof e&&(e={url:e});var r=new P(e);if(r.emit=function(e){P.prototype.emit.call(r,e),t.$emit(e,r)},this._ssrContext=_(this.ssrContext||A.prototype.ssrContext),!this._server&&r.key&&r.prefetch&&this._ssrContext){var n=this._ssrContext[r.key];n&&(n.prefetched=!0),Object.assign(r,n)}return r}}},L={cache:null,debounce:50,deep:!0,keepData:!0,auto:"get",prefetch:!0,prefetchTimeout:4e3,transformer:null,ssrContext:null};function R(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e=Object.assign({},L,e),t.mixin(D),t.component("chimera-endpoint",q);var r=e,n=r.deep,i=r.ssrContext,o=r.axios,s=d(r,["deep","ssrContext","axios"]);P.prototype.options=s,Object.assign(A.prototype,{deep:n,ssrContext:i,axios:o}),t.config.optionMergeStrategies.chimera=function(t,e,r){return t?e?("function"==typeof e&&(e=e.call(r)),"function"==typeof t&&(t=t.call(r)),Object.assign({},t,e,t.$options&&e.$options?{$options:P.applyDefaults(t.$options,e.$options)}:{})):t:e}}return t.ChimeraEndpoint=q,t.Endpoint=P,t.default=R,t.install=R,t}({},axios);
